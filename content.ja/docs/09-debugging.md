---
title: デバッグ
type: docs
weight: 10
---


# デバッグ

WebRTCのデバッグは、非常に困難な作業です。たくさんの可動部品があり、それらがすべて独立して壊れる可能性があります。注意していないと、間違ったものを探すために何週間もの時間を費やすことになります。やっと壊れた部品を見つけても、その原因を理解するためには、少し勉強する必要があります。

本章では、WebRTC をデバッグするための心構えを身につけます。問題をどのように分解するかを説明します。問題を把握した後は、一般的なデバッグツールを簡単にご紹介します。

### 問題の切り分け
デバッグの際には、問題がどこから発生しているのかを切り分ける必要があります。問題の始まりから始めてみましょう。

#### シグナリングの失敗
#### ネットワーキングの失敗

netcatを使ってSTUNサーバーをテストします。

1. **20バイト**のバインディングリクエストパケットを準備します。

    ```
    echo -ne "\x00\x01\x00\x00\x21\x12\xA4\x42TESTTESTTEST" | hexdump -C
    00000000  00 01 00 00 21 12 a4 42  54 45 53 54 54 45 53 54  |....!..BTESTTEST|
    00000010  54 45 53 54                                       |TEST|
    00000014
    ```

    の解釈を行います。

    - `0001` はメッセージタイプ

    - `00 00` はデータセクションの長さです。

    - `21 12 a4 42` はマジック・クッキーです。

    - `54 45 53 54 54 45 53 54 54 45 53 54` (ASCIIでは `TESTTESTTEST` とデコードされます)は12バイトのトランザクションIDです。

2. リクエストを送信し、**32バイト**のレスポンスを待ちます。

    ```
    stunserver=stun1.l.google.com;stunport=19302;listenport=20000;echo -ne "\x00\x01\x00\x00\x21\x12\xA4\x42TESTTESTTEST" | nc -u -p $listenport $stunserver $stunport -w 1 | hexdump -C
    00000000  01 01 00 0c 21 12 a4 42  54 45 53 54 54 45 53 54  |....!..BTESTTEST|
    00000010  54 45 53 54 00 20 00 08  00 01 6f 32 7f 36 de 89  |TEST. ....o2.6..|
    00000020
    ```

    の解釈を行います:

    - `01 01` はメッセージタイプ

    - `00 0c` はデータセクションの長さで、10進数では12にデコードされます。

    - `21 12 a4 42` は、マジッククッキーです。

    - そして、`54 45 53 54 54 45 53 54 54 45 53 54`（ASCIIでは`TESTTESTTEST`とデコードされる）は、12バイトのトランザクションIDです。

    - `00 20 00 08 00 01 6f 32 7f 36 de 89` は 12 バイトのデータで解釈は次のようになります:

        - `00 20` はタイプ: `xor-mapped-address` です。

        - `00 08` は値の部分の長さで、10進数では8にデコードされます。

        - `00 01 6f 32 7f 36 de 89` はデータの値で、以下のように解釈します:

            - `00 01` はアドレスタイプ(IPv4)です

            - `6f 32` は XOR マップされたポートです

            - `7f 36 de 89` はXORマップされたIPアドレスです

XORマップされた部分を解読するのは面倒ですが、`00 00 00 00`に設定された(無効な)ダミーのマジッククッキーを与えることで、stunサーバを騙してダミーのXORマップを実行させることができます。

```
stunserver=stun1.l.google.com;stunport=19302;listenport=20000;echo -ne "\x00\x01\x00\x00\x00\x00\x00\x00TESTTESTTEST" | nc -u -p $listenport $stunserver $stunport -w 1 | hexdump -C
00000000  01 01 00 0c 00 00 00 00  54 45 53 54 54 45 53 54  |........TESTTEST|
00000010  54 45 53 54 00 01 00 08  00 01 4e 20 5e 24 7a cb  |TEST......N ^$z.|
00000020
```

ダミーのマジッククッキーとのXORは冪等であるため、ポートとアドレスはレスポンスに明確に表示されます（IPアドレスをごまかして通過するパケットを操作するルータもあるため、すべての状況でこれが機能するわけではありません）。

  - `00 01 4e 20 5e 24 7a cb` がデータ値で、解釈は次のようになります:

    - `00 01` はアドレスタイプ（IPv4）です

    - `4e 20` はマップされたポートで，10進数で 20000 にデコードされます

    - `5e 24 7a cb` は IP アドレスで，ドット 10 進表記では `94.36.122.203` となります

#### セキュリティの失敗
#### メディアの障害
#### データの障害

### Tools of the trade

#### netcat (nc)

[netcat](https://en.wikipedia.org/wiki/Netcat)は、TCP や UDP を使ったネットワーク接続を読み書きするためのコマンドラインネットワークユーティリティです。主に `nc` コマンドとして利用できます。

#### tcpdump

[tcpdump](https://en.wikipedia.org/wiki/Tcpdump) は、コマンドラインのデータネットワークパケットアナライザです。

一般的なコマンドです。

- 19302 番ポートとの間の UDP パケットをキャプチャし、パケットの内容を 16 進数で表示します。

    `sudo tcpdump 'udp port 19302' -xx`

- 同じくパケットをPCAP(packet capture)ファイルに保存して後で確認する。

    `sudo tcpdump 'udp port 19302' -w stun.pcap`

  PCAPファイルは、wiresharkのGUIで開くことができます。`wireshark stun.pcap` です。

#### wireshark
#### webrtc-internals
